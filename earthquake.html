<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earthquake Map</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .sidebar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 400px;
            background-color: rgba(255, 255, 255, 0.95);
            overflow-y: auto;
            padding: 20px;
            z-index: 1;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .sidebar h1 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #333;
        }

        .sidebar h2 {
            font-size: 18px;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #555;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th {
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            text-align: left;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background-color: #34495e;
        }

        td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        /* Hide sidebar on small screens */
        @media (max-width: 1023px) {
            .sidebar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="sidebar">
        <h1>Earthquake Monitor</h1>
        <p>Click on column headers to sort</p>
        <h2>Recent Earthquakes</h2>
        <table id="earthquake-table">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">Location</th>
                    <th onclick="sortTable(1)">Magnitude</th>
                    <th onclick="sortTable(2)">Depth (km)</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <!-- Data will be populated here -->
            </tbody>
        </table>
    </div>

    <script>
        // Mapbox access token - REPLACE WITH YOUR OWN TOKEN
        mapboxgl.accessToken = 'YOUR_MAPBOX_ACCESS_TOKEN';

        // Initialize map
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v11',
            center: [138, 38],
            zoom: 4
        });

        // Global variable for table data
        let tableData = [];
        let currentSortColumn = -1;
        let sortAscending = true;

        // Load earthquake data
        map.on('load', () => {
            // Load earthquake GeoJSON
            fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/4.5_week.geojson')
                .then(response => response.json())
                .then(data => {
                    // Filter for earthquakes near Japan
                    const japanEarthquakes = {
                        type: 'FeatureCollection',
                        features: data.features.filter(feature => {
                            const coords = feature.geometry.coordinates;
                            return coords[0] >= 125 && coords[0] <= 150 && 
                                   coords[1] >= 25 && coords[1] <= 50;
                        })
                    };

                    // Add earthquake source
                    map.addSource('earthquakes', {
                        type: 'geojson',
                        data: japanEarthquakes
                    });

                    // Add earthquake layer
                    map.addLayer({
                        id: 'earthquake-circles',
                        type: 'circle',
                        source: 'earthquakes',
                        paint: {
                            'circle-radius': [
                                'interpolate',
                                ['linear'],
                                ['get', 'mag'],
                                4, 5,
                                6, 15,
                                8, 30
                            ],
                            'circle-color': [
                                'interpolate',
                                ['linear'],
                                ['get', 'mag'],
                                4, '#ffffb2',
                                5, '#fed976',
                                6, '#feb24c',
                                7, '#fd8d3c',
                                8, '#f03b20'
                            ],
                            'circle-opacity': 0.7,
                            'circle-stroke-width': 1,
                            'circle-stroke-color': '#fff'
                        }
                    });

                    // Populate table
                    populateTable(japanEarthquakes.features);

                    // Add popups
                    map.on('click', 'earthquake-circles', (e) => {
                        const coordinates = e.features[0].geometry.coordinates.slice();
                        const props = e.features[0].properties;
                        
                        new mapboxgl.Popup()
                            .setLngLat(coordinates)
                            .setHTML(`
                                <strong>${props.place}</strong><br>
                                Magnitude: ${props.mag}<br>
                                Depth: ${coordinates[2]} km
                            `)
                            .addTo(map);
                    });

                    map.on('mouseenter', 'earthquake-circles', () => {
                        map.getCanvas().style.cursor = 'pointer';
                    });

                    map.on('mouseleave', 'earthquake-circles', () => {
                        map.getCanvas().style.cursor = '';
                    });
                })
                .catch(error => console.error('Error loading earthquake data:', error));

            // Load Japan boundaries
            fetch('https://raw.githubusercontent.com/dataofjapan/land/master/japan.geojson')
                .then(response => response.json())
                .then(data => {
                    map.addSource('japan', {
                        type: 'geojson',
                        data: data
                    });

                    map.addLayer({
                        id: 'japan-fill',
                        type: 'fill',
                        source: 'japan',
                        paint: {
                            'fill-color': '#627BC1',
                            'fill-opacity': 0.1
                        }
                    });

                    map.addLayer({
                        id: 'japan-outline',
                        type: 'line',
                        source: 'japan',
                        paint: {
                            'line-color': '#627BC1',
                            'line-width': 2
                        }
                    });
                })
                .catch(error => console.error('Error loading Japan data:', error));
        });

        // Populate table function
        function populateTable(features) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            tableData = features.map(feature => ({
                place: feature.properties.place,
                magnitude: feature.properties.mag,
                depth: feature.geometry.coordinates[2]
            }));

            tableData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.place}</td>
                    <td>${row.magnitude.toFixed(1)}</td>
                    <td>${row.depth.toFixed(0)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Sort table function
        function sortTable(columnIndex) {
            const tbody = document.getElementById('table-body');
            const keys = ['place', 'magnitude', 'depth'];
            const key = keys[columnIndex];

            // Toggle sort direction if same column
            if (currentSortColumn === columnIndex) {
                sortAscending = !sortAscending;
            } else {
                sortAscending = true;
                currentSortColumn = columnIndex;
            }

            // Sort data
            tableData.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];

                // Handle string comparison
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (valA < valB) return sortAscending ? -1 : 1;
                if (valA > valB) return sortAscending ? 1 : -1;
                return 0;
            });

            // Re-populate table
            tbody.innerHTML = '';
            tableData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.place}</td>
                    <td>${row.magnitude.toFixed(1)}</td>
                    <td>${row.depth.toFixed(0)}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
